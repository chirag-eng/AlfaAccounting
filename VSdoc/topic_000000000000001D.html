<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW" />
    <title>BookingViewModelsController.Create Method</title>
    <meta name="Microsoft.Help.TopicVersion" content="10" />
    <meta name="Microsoft.Help.Id" content="M:AlfaAccounting.Controllers.BookingViewModelsController.Create" />
    <meta name="SelfBranded" content="false" />
    <meta name="Title" content="BookingViewModelsController.Create Method" />

		<meta name="Microsoft.Help.TocParent" content="Methods.T:AlfaAccounting.Controllers.BookingViewModelsController" />    
		<meta name="Microsoft.Help.F1" content="AlfaAccounting.Controllers.BookingViewModelsController.Create" />
    <meta name="Microsoft.Help.Keywords" content="Create Method" />
    <meta name="Microsoft.Help.Keywords" content="AlfaAccounting.Controllers.BookingViewModelsController.Create Method" />
    
    <meta name="Microsoft.Help.ContentType" content="Reference" />
    <meta name="Microsoft.Help.Category" content="TargetOS:Windows" />
    <meta name="Microsoft.Help.Category" content="DevLang:VB" />
    <meta name="Microsoft.Help.Category" content="DevLang:CSharp" />
    <meta name="Microsoft.Help.Category" content="DevLang:FSharp" />
    <meta name="Description" content="AlfaAccounting.Controllers.BookingViewModelsController.Create Method" />
    <meta name="Microsoft.Help.TOCParentTopicVersion" content="10" />
    <meta name="Microsoft.Help.TocOrder" content="0" />
    <meta name="Microsoft.Help.Product" content="AlfaAccounting Reference" />
    <style type="text/css">.class-diagram img {border: none;}</style>
    <script src="mshv2.js"></script>
  </head>
    <body class="primary-mtps-offline-document" 
	onload="try{onLoad(); var nod=document.getElementById('vsdocman_init_script');var newNod=document.createElement('script');newNod.type= 'text/javascript';nod.parentNode.replaceChild(newNod,nod);newNod.text=nod.innerHTML;vsdocman_topic_init();}catch(ex){}">
  
<div id="vsdocman_init_script" style="display:none;">
// <!-- the script cannot contain the following text (without dots): -.-.> or -.-
function vsdocman_topic_init() {
	try {
		extractCode();
	} catch (ex) {
	}
	
	try {
		var divs = document.documentElement.getElementsByTagName("div");
		var i;
		var footerRemoved = false;
		for (i=divs.length-1; i>=0; i=i-1) {
			var div = divs[i];
	
			// remove VS branding footer
			if (!footerRemoved) {
				if (div.className == "OH_footer") {
					div.style.display = "none";
					footerRemoved = true;
				}
			}
			
			// remove VS branding feedback link
			if (div.className == "OH_feedbacklink") {
				div.style.display = "none";
			}
		}

		var tds = document.documentElement.getElementsByTagName("td");
		for (i=0; i<tds.length; i++) {
			var td = tds[i];
	
			// remove VS branding logo
			if (td.className == "OH_tdLogoColumn") {
				td.style.display = "none";
			}
		}
	} catch (ex) {
	}
	
	hideImageMapAreaLinks();
	fixLinks();
	fixNewlinesInSyntax();
}


/**
 * Fixes <br />\n sequences in syntax declarations. Only <br/> 
 * is needed.
 */  
function fixNewlinesInSyntax() {
	try {
		var i;
		var snippets = document.documentElement.getElementsByTagName("CodeSnippet");
		for (i=0; i<snippets.length; i++) {
			var containsMarkup = snippets[i].getAttribute("ContainsMarkup");
			if (containsMarkup == "true") {
				// it is syntax section
				// surround fixed text with <pre> tag, otherwise IE normalizes all whitespaces during setting innerHTML
				snippets[i].parentNode.innerHTML = "<pre>" + snippets[i].parentNode.innerHTML.replace(/<br>\r?\n/gi, "<br>") + "</pre>";
			}
		}
	} catch (ex) {
	}
}


/**
 * MS Help Viewer (at least version 1) removes style="display:none;". 
 * Set it back.
 */  
function hideImageMapAreaLinks() {
	try {
		var i;
		var maps = document.documentElement.getElementsByTagName("map");
		for (i=0; i<maps.length; i++) {
			var mapId = maps[i].getAttribute("name");
			var invisibleLinks = document.getElementById("invisible_imagemap_links_" + mapId);
			invisibleLinks.style.display="none";
		}
	} catch (ex) {
	}
}


// Escapes id query variables in internal links and corrects external links. 
function fixLinks() {
	try {
		var i;
		var links = document.documentElement.getElementsByTagName("a");
		var urlParameters = getUrlParameters();
		for (i=0; i<links.length; i++) {
			var hrf = links[i].getAttribute("hr" + "ef");
			var escaped = escapeIdQueryVariable(hrf);
			
			var idValue = escaped[1];
			if (idValue != "") {
				var isExternal = (idValue.toLowerCase().indexOf("http://", 0) >= 0);
				isExternal = isExternal || (idValue.toLowerCase().indexOf("https://", 0) >= 0);
				var isHttp = isExternal;
				isExternal = isExternal || (idValue.toLowerCase().indexOf("mailto:", 0) >= 0);
				if (isExternal) {
					// external link
					//  Help3 system converts each Id to uppercase, so convert it to lowercase.
					//  It's bigger chance the URL will be correct.
					hrf = idValue.toLowerCase();
					if (isHttp) {
						links[i].className = "mtps-external-link";
					}
				} else {
					// help3 link
					hrf = escaped[0];
					// some links (e.g. in syntax section) don't have complete parameters generated by Help3 system
					if (hrf.indexOf("method=page", 0) < 0) {
						hrf = hrf + "&" + urlParameters;
					}
				}
	
				links[i].setAttribute("hr" + "ef", hrf);
			}
		}
	} catch (ex) {
	}
}


var idQueryVariablePattern = /(\&|\?|^)(id\=)(.*?)(\&|$)/i;

// Returns array with 2 items. The first one is resulting complete queryString with
// escaped id variable. The second one is original value of id variable. 
function escapeIdQueryVariable(input) {
	var match = input.match(idQueryVariablePattern);
	var idValue = "";
	if (match) {
		idValue = input.match(idQueryVariablePattern)[3];
		input = input.replace(idQueryVariablePattern, "$1$2" + escape(idValue) + "$4");
	}
	var res = new Array();
	res[0] = input;
	res[1] = idValue;
	return res;
} 


function getUrlParameters() {
	var res;
	res = "product=" + getQueryVariable("product") + "&";
	res = res + "productversion=" + getQueryVariable("productversion") + "&";
	res = res + "method=page&";
	return res;
}


function getQueryVariable(variable) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0; i<vars.length; i++) {
    var pair = vars[i].split("=");
    if (pair[0].toLowerCase() == variable.toLowerCase()) {
      return pair[1];
    }
  }
  return "";
} 


function extractCode(parentNode) {
	var comments = getAllComments(parentNode);

	var comment;
  for(var i=0; i<comments.length; i++){
    comment = comments[i];
  	var matches = comment.nodeValue.match(/(?:^\s*VSDOCMAN SCRIPT)((.|\r\n)*)$/);
		// Match returns array. Index 0 is complete match. Index 1 is the first captured group.
		// The group is defined by (). The ?: means that the group is not captured. 
  	if (matches != null) {
	    //res.push(matches[1]);
	    createElement("div", matches[1], comment);
    }
  }
}


function getAllComments(parentNode) {
	if (parentNode == null) {
		parentNode = document.documentElement;
	}
	var children = parentNode.childNodes;
	var res = new Array();
  if(parentNode.nodeType == 8){
  	// 8 = comment
    res.push(parentNode);
  }
	    
  for(var i=0; i<children.length; i++){
      res = res.concat(getAllComments(children[i]));
  }
  return (res);
}


// Create new element and replace existing one with it
function createElement(name, innerHtml, oldElm) {
	// setting innerHTML containing script tags doesn't work in IE
	var scriptBodies = new Array();
	var scriptMatch;
	var i = 0;
	var scriptPattern = /(<script.*?>)((.|\r\n)*?)(<\/script>)/i;
	do {
		scriptMatch = innerHtml.match(scriptPattern);
		if (scriptMatch != null) {
			// found the script tag
			//  get its innerHtml
			scriptBodies[i] = scriptMatch[2];
			// replace this script tag with span tag
			innerHtml = innerHtml.replace(scriptPattern, "<span script_index=\"" + i + "\"></span>");
		}
		i++;
	} while(scriptMatch != null && i < 100);
	
	var elm = document.createElement(name);
	elm.innerHTML = innerHtml;
	oldElm.parentNode.replaceChild(elm,oldElm);
	
	// now create script tags and replace corresponding span tags
	var allSpans = elm.getElementsByTagName('span');
	var scriptSpans = new Array();
	for (i=0; i<allSpans.length; i++) {
		if (allSpans[i].getAttribute("script_index")) {
			var index = allSpans[i].getAttribute("script_index");
			scriptSpans[index] = allSpans[i];
		}
	}
	for (i=0; i<scriptBodies.length; i++) {
		insertScriptElement(scriptBodies[i], scriptSpans[i], getUniqueIndex());
	}
}

var uniqueIndex = 0;
function getUniqueIndex() {
	return uniqueIndex++;
}

function insertScriptElement(innerHtml, oldNode, scriptIndex) {
	var newNod=document.createElement('script');
	newNod.type = 'text/javascript';
	newNod.setAttribute("defer", "defer");
	oldNode.parentNode.replaceChild(newNod, oldNode);
	// add a test whether the script was evaluated
	var newInnerHtml = "\nvar vsdocmanScript" + scriptIndex + "executed = true;\n" + innerHtml;
	newNod.text=newInnerHtml;
	//run the script if necessary
	try {
		eval("vsdocmanScript" + scriptIndex + "executed");
	} catch (ex) {
		// not evaluated yet
		eval(innerHtml);
	}
}

// *** CLASS DIAGRAM CLICKING ***
// To navigate any kind of link, we need to call click() method on the element.
// It's because of <MSHelp:link links in Help2 format (only used in IE). 
// Default click event in FF doesn't trigger the link (in IE it does).
// Fix it. 
function performClick(element) {
	if (document.createEventObject){
		// IE
		return element.click();
	}
	else{
		// dispatch for firefox + others
		var evt = element.ownerDocument.createEvent('MouseEvents');
		evt.initMouseEvent('click', true, true, element.ownerDocument.defaultView, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
		element.dispatchEvent(evt);
	}
	
	while (element) {
		if (element.tagName == "A" && element.href != "") {
			if (element.target != "") {
				window.open(element.href, element.target);
			} else {
				document.location = element.href;
			}
			element = null;
		}	else {
			element = element.parentElement;
		}
	}
}

function clickElement(callerElement) {
	try {
		var elementHTML;
		var tagName;
		var innerCode;
		var attributes;
		var clickActionGuid;
		
		// get HTML source code of element to be clicked 
		clickActionGuid = callerElement.getAttribute("click-cref-guid");
		elementHTML = document.getElementById(clickActionGuid).innerHTML;
		
		// parse HTML element code
		var elementPattern = /<(.+?)\s+(.*)>(.*)<.+?>/igm;
		elementPattern.lastIndex = 0;
		var match = elementPattern.exec(elementHTML);
		tagName = match[1];
		attributes = match[2];
		innerCode = match[3];
		
		//get array of "attr=value" strings 	
		attributes = unescapeHTML(attributes);
		attributes = attributes.match(/\s*(.*?)\s*=\s*(["'])(.*?)\2/igm);
		
		// create element with attributes
		var el = document.createElement(tagName);
		//el.innerHTML = innerCode;
		var i;
		var attrPattern = /\s*(.*?)\s*=\s*(["'])(.*?)\2/igm;
		for (i=0; i<attributes.length; i++) {
			attrPattern.lastIndex = 0;
			match = attrPattern.exec(attributes[i]);
			el.setAttribute(match[1], match[3]);
		}

		document.body.appendChild(el);
		performClick(el);
	} catch (ex) {
	}
	return false;
}

function unescapeHTML (str) {
	return str.replace(/&amp;/g,"&").
		replace(/>/g,"&gt;").
		replace(/</g,"&lt;");//. 
		//the following doesn't work for some reason: replace(/"/g,"&quot;");                                         
}

// -->		
</div>
    <div class="topic">
      <div class="majorTitle">AlfaAccounting Reference
      </div>
      <div class="title">BookingViewModelsController.Create Method
      </div>
      <div id="mainSection">
        <div id="mainBody">
          <div>
            <div class="summary">
       
			        Open Gateway to the Braintree and make payment of the passed amount and submit for the settlement
when successful and if NewInvoice Session data is not null saves the new booking
                    to the Boooking Invoice, Payemnt and Payment History databases and clear shopping cart item.
                    if tempInvoiceDetailVeiwmodel TempData is not null saves the remainging payment amount related update
                    to the Invoice, Booking, Payemnt and Payment History databases
                    if MyBookingCancelationRequrest Session data is not null, cancelation related payment amount updated on
                    booking, invoice, payment and paymentHisotry database
                    if BookingUpdated and InvoiceUpdated TempData that is from amdend booking acion is not null,
                    appropriate extra depsit charge or cancellation fee or reduced hrs deposit refund related change get amended to
                    Booking, invoice, payemt and paymenthistory database.


            </div>
          </div>
          <p>
          </p>

          <strong>Namespace:</strong> 
<a href="ms-xhelp:///?Id=N:AlfaAccounting.Controllers">AlfaAccounting.Controllers</a>



<br />

    
          <strong>Assembly:</strong>
          <span>AlfaAccounting (in AlfaAccounting.dll)</span>








<CollapsibleArea runat="server" Expanded="1" Title="Syntax" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="syntaxToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>

            
            
						
	<CodeSnippet xml:space="preserve" runat="server" Language="CSharp" DisplayLanguage="C#" ContainsMarkup="true" EnableCopyCode="false">public ActionResult Create()</CodeSnippet>
            
						
            
						






<div id="returns" xmlns="http://www.w3.org/1999/xhtml">
  <h4 class="subHeading">Return Value</h4>
  <span>
	Type: <a href="ms-xhelp:///?Id=T:System.Web.Mvc.ActionResult">ActionResult</a><br />
	    <span>returns show view</span>
    <br />
	
  </span>
</div>










</CollapsibleArea>





















<CollapsibleArea runat="server" Expanded="1" Title="Source code" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="sourceCodeToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>
  <div id="snippetGroup" xmlns="http://www.w3.org/1999/xhtml">

<CodeSnippet EnableCopyCode="true" runat="server" Language="CSharp" ContainsMarkup="false" DisplayLanguage="C#" xmlns="http://msdn2.microsoft.com/mtps">
public ActionResult Create()
 {
     var gateway = config.GetGateway();
     Decimal amount;
 
     try
     {
         amount = Convert.ToDecimal(Request[&#34;amount&#34;]);
     }
     catch (FormatException e)
     {
         TempData[&#34;Flash&#34;] = &#34;Error: 81503: Amount is an invalid format.&#34;;
         return RedirectToAction(&#34;New&#34;);
     }
 
     var nonce = Request[&#34;payment_method_nonce&#34;];
     var request = new TransactionRequest
     {
         Amount = amount,
         PaymentMethodNonce = nonce,
         Options = new TransactionOptionsRequest
         {
             SubmitForSettlement = true
         }
     };
 
     Result&#60;Transaction&#62; result = gateway.Transaction.Sale(request);
     if (result.IsSuccess())
     {
         Transaction transaction = result.Target;
         //                var listNewBookingToBeSavedToDb = Session[&#34;ListNewBookingToBeSavedToDb&#34;] as List&#60;Booking&#62;;
         //if new deposit payment is getting paid passed from confirm booking
         var newInvoice = Session[&#34;NewInvoice&#34;] as Invoice;
         if (newInvoice != null)
         {
             //temporality empty the booking so that entity framework change tracker can save Invoice records in invoice table.
             var newBkgs = newInvoice.Bookings;
             newInvoice.Bookings = null;
             db.Invoices.Add(newInvoice);
             db.SaveChanges();
             //save the invoice in those booking records in database many to many
             foreach (var ngkg in newBkgs)
             {
                 //db.Bookings.SingleOrDefault(b =&#62; b.ItemDescription == ngkg.ItemDescription).Invoices.Add(newInvoice); b-i many to many
                 db.Bookings.SingleOrDefault(b =&#62; b.ItemDescription == ngkg.ItemDescription).Invoice = newInvoice;
                 db.SaveChanges();
             };
 
             //save payemnt detail to the database 
             var userid = User.Identity.GetUserId();
             var newPayment = new Payment()
             {
                 PaymentDateTime = DateTime.Now,
                 //CreditAmount = (float)amount,
                 //DebitAmount = 0f,
                 CreditDepositAmount = (float)amount,
                 DebitDepositAmount = 0f,
                 CreditRemainingAmount = 0f,
                 DebitRemainingAmount = 0f,
                 CreditCancellationFee = 0f,
                 Id = userid,
                 InvoiceId = newInvoice.InvoiceId,
                 PaymentType = &#34;Deposit&#34;,
                 TransactionId = transaction.Id
             };
             db.Payments.Add(newPayment);
             db.SaveChanges();
 
             //Create newPaymentHistory
             var newPaymentHistory = new PaymentHistory()
             {
                 PaymentDateTime = DateTime.Now,
                 CreditAmount = (float)amount,
                 DebitAmount = 0f,
                 Id = userid,
                 PaymentId = newPayment.PaymentId,
                 InvoiceId = newInvoice.InvoiceId,
                 PaymentType = PaymentType.Deposit,
                 TransactionId = transaction.Id
             };
             db.PaymentHistories.Add(newPaymentHistory); ;
             db.SaveChanges();
 
             //if bookings that matches booking id in cartItems does not have invoices allocated at this point,
             // remove them from Bookings database table,
             //getcart items first
             var cart = ShoppingCart.GetCart(this.HttpContext);
             var cartItems = cart.GetCartItems();
             //remove cart item and booking if stil does not allocated invoices
             foreach (var cartItem in cartItems)
             {
                 var cartItemBooking = db.Bookings.SingleOrDefault(b =&#62; b.BookingId == cartItem.BookingId);
                 //if (cartItemBooking.Invoices == null) b-i many to many
                 if (cartItemBooking.Invoice == null)
                 {
                     //cart.RemoveFromCart(cartItem.CartRecordId);
                     db.Bookings.Remove(cartItemBooking);
                 }
             }
             //empty cart
             cart.EmptyCart();
         }
         //if remaining amount is getting paid 
         /*var selectedPaymentIndexViewModels = Session[&#34;SelectedPaymentIndexViewModels&#34;] as PaymentIndexViewModel;*/
         var tempInvoiceDetail = TempData[&#34;tempInvoiceDetailViewModel&#34;] as InvoiceDetailViewModel;
         if (tempInvoiceDetail != null /*|| selectedPaymentIndexViewModels != null*/)
         {
             Invoice selectedInvoice = null;
             //if (selectedPaymentIndexViewModels != null)
             //{
             //    selectedInvoice = db.Invoices.Find(selectedPaymentIndexViewModels.InvoiceId);
             //}
             //else
             {
                 selectedInvoice = db.Invoices.Find(tempInvoiceDetail.InvoiceId);
             }
             if (selectedInvoice == null)
             {
                 return HttpNotFound();
             }
             //find out sub total and deposit amount of bookings first
             var TotalbkgSubT = 0f;
             var TotalbkgDeposit = 0f;
             foreach (var item in selectedInvoice.Bookings)
             {
                 if (item.BookingStatus != BookingStatus.Cancelled)
                 {
                     TotalbkgSubT += item.Subtotal;
                     TotalbkgDeposit += item.BookingDeposit;
                 }
             }
             //insert recievable remaining amount to the selected Invoice
             selectedInvoice.ReceivableRemainingAmount = TotalbkgSubT - TotalbkgDeposit;
 
             // save it to the selectedInvoice modification to database
             if (ModelState.IsValid)
             {
                 db.Entry(selectedInvoice).State = EntityState.Modified;
                 db.SaveChanges();
             }
             Session[&#34;updatedInvoice&#34;] = selectedInvoice;
 
             //find payment id
             var paymentid = db.Payments.FirstOrDefault(p =&#62; p.InvoiceId == tempInvoiceDetail.InvoiceId).PaymentId;
 
             var selectedPayment = db.Payments.Find(paymentid);
             if (selectedPayment == null)
             {
                 return HttpNotFound();
             }
             selectedPayment.CreditRemainingAmount = (float)amount;
             selectedPayment.PaymentType = &#34;Remaining&#34;;
             //selectedPayment.CreditAmount = (float)amount;
 
             if (ModelState.IsValid)
             {
                 db.Entry(selectedPayment).State = EntityState.Modified;
                 db.SaveChanges();
             }
 
             var userid = User.Identity.GetUserId();
             var newPaymentHistory = new PaymentHistory()
             {
                 PaymentDateTime = DateTime.Now,
                 CreditAmount = (float)amount,
                 DebitAmount = 0f,
                 Id = userid,
                 PaymentId = selectedPayment.PaymentId,
                 InvoiceId = selectedInvoice.InvoiceId,
                 PaymentType = PaymentType.Remaining,
                 TransactionId = transaction.Id
             };
             db.PaymentHistories.Add(newPaymentHistory); ;
             db.SaveChanges();
             //var userid = User.Identity.GetUserId();
             //var newPayment = new Payment()
             //{
             //    PaymentDateTime = DateTime.Now,
             //    CreditAmount = (float)amount,
             //    DebitAmount = 0f,
             //    CreditDepositAmount = 0f,
             //    DebitDepositAmount = 0f,
             //    CreditRemainingAmount = (float)amount,
             //    DebitRemainingAmount = 0f,
             //    CreditCancellationFee = 0f,
             //    Id = userid,
             //    InvoiceId = selectedInvoice.InvoiceId,
             //    PaymentType = &#34;Remaining&#34;,
             //    TransactionId = transaction.Id
             //};
             //db.Payments.Add(newPayment);
             //db.SaveChanges();
             Session[&#34;SelectedPaymentIndexViewModels&#34;] = null;
         }
 
         // cancellation fee getting paid
         var myBookingCancellationRequest = Session[&#34;MyBookingCancellationRequest&#34;] as MyBookingCancellation;
         if (myBookingCancellationRequest != null)
         {
             var selectedBooking = db.Bookings.Find(myBookingCancellationRequest.BookingId);
             if (selectedBooking == null)
             {
                 return HttpNotFound();
             }
             //change the booking status to &#34;cancelled and assign cancellation fee of 25 to booking cancellation
             selectedBooking.BookingStatus = BookingStatus.Cancelled;
             selectedBooking.BookingCancellationFee = (float)amount;
             if (ModelState.IsValid)
             {
                 db.Entry(selectedBooking).State = EntityState.Modified;
                 db.SaveChanges();
             }
             //find invoice id 
             var invid = myBookingCancellationRequest.Invoice.InvoiceId;
             var selectedInvoice = db.Invoices.Find(invid);
             if (selectedInvoice == null)
             {
                 return HttpNotFound();
             }
             selectedInvoice.InvoiceCancellationFee = (float)amount;
             if (ModelState.IsValid)
             {
                 db.Entry(selectedInvoice).State = EntityState.Modified;
                 db.SaveChanges();
             }
             //find payment id
             var paymentid = db.Payments.FirstOrDefault(p =&#62; p.InvoiceId == myBookingCancellationRequest.Invoice.InvoiceId).PaymentId;
             //foreach (var item in selectedInvoice.Payments)
             //{
             //    if (item.PaymentType == &#34;Deposit&#34;)
             //    {
             //        paymentid = item.PaymentId;
             //    }
             //}
             var selectedPayment = db.Payments.Find(paymentid);
             if (selectedPayment == null)
             {
                 return HttpNotFound();
             }
             selectedPayment.CreditCancellationFee = selectedPayment.CreditCancellationFee + (float)amount;
 
             if (ModelState.IsValid)
             {
                 db.Entry(selectedPayment).State = EntityState.Modified;
                 db.SaveChanges();
             }
             var userid = User.Identity.GetUserId();
             var newPaymentHistory = new PaymentHistory()
             {
                 PaymentDateTime = DateTime.Now,
                 CreditAmount = (float)amount,
                 DebitAmount = 0f,
                 Id = userid,
                 PaymentId = selectedPayment.PaymentId,
                 InvoiceId = selectedInvoice.InvoiceId,
                 PaymentType = PaymentType.CancellationFee,
                 TransactionId = transaction.Id
             };
             db.PaymentHistories.Add(newPaymentHistory); ;
             db.SaveChanges();
             //var userid = User.Identity.GetUserId();
             //var newPayment = new Payment()
             //{
             //    PaymentDateTime = DateTime.Now,
             //    CreditAmount = (float)amount,
             //    DebitAmount = 0f,
             //    //CreditDepositAmount = 0f,
             //    //DebitDepositAmount = 0f,
             //    //CreditRemainingAmount = 0f,
             //    //DebitRemainingAmount = 0f,
             //    //CreditCancellationFee = (float)amount,
             //    Id = userid,
             //    InvoiceId = selectedInvoice.InvoiceId,
             //    PaymentType = &#34;CancellationFee&#34;,
             //    TransactionId = transaction.Id
             //};
             //db.Payments.Add(newPayment);
             //db.SaveChanges();
         }
 
         //if amend Booking aditional payment is getting paid
         var bookingUpdated = TempData[&#34;BookingUpdated&#34;] as Booking;
         var invoiceUpdated = TempData[&#34;InvoiceUpdated&#34;] as Invoice;
 
         if (invoiceUpdated != null)
         {
             //extract payment that matches with the invoiceid from the invoiceUpdated
             Payment thisPayment = db.Payments.Where(p =&#62; p.InvoiceId == invoiceUpdated.InvoiceId).FirstOrDefault();
             var thisPaymentid = thisPayment.PaymentId;
             {
                 // set selected payemnt&#39;s payment type to Deposit cancelled
                 //and put amount in the payment debit amount
                 if (thisPayment == null)
                 { return HttpNotFound(); }
 
                 if (invoiceUpdated.InvoiceCancellationFee &#62; 0)
                 { thisPayment.CreditCancellationFee = (float)amount; }
                 else { thisPayment.CreditDepositAmount = thisPayment.CreditDepositAmount + (float)amount; }
 
                 //if (invoiceUpdated != null &#38;&#38; bookingUpdated.BookingStatus == BookingStatus.Cancelled) { thisPayment.PaymentType = &#34;DepositCancelled&#34;; }
                 if (ModelState.IsValid)
                 {
                     db.Entry(thisPayment).State = EntityState.Modified;
                     db.SaveChanges();
                 }
 
                 string userid = User.Identity.GetUserId();
                 var newPaymentHistory = new PaymentHistory()
                 {
                     PaymentDateTime = DateTime.Now,
                     CreditAmount = (float)amount,
                     DebitAmount = 0f,
                     Id = userid,
                     PaymentId = thisPaymentid,
                     InvoiceId = invoiceUpdated.InvoiceId,
                     PaymentType = PaymentType.Deposit,
                     TransactionId = transaction.Id
                 };
                 db.PaymentHistories.Add(newPaymentHistory); ;
                 db.SaveChanges();
 
 
                 //save updated invoice on to database
                 Invoice thisInvoice = db.Invoices.Where(i =&#62; i.InvoiceId == invoiceUpdated.InvoiceId).FirstOrDefault();
                 thisInvoice.ReceivableDepositAmount = invoiceUpdated.ReceivableDepositAmount;
                 thisInvoice.ReceivableRemainingAmount = invoiceUpdated.ReceivableRemainingAmount;
                 thisInvoice.PayableDepositAmount = invoiceUpdated.PayableDepositAmount;
                 thisInvoice.PayableAmount = invoiceUpdated.PayableAmount;
 
                 if (ModelState.IsValid)
                 {
                     db.Entry(thisInvoice).State = EntityState.Modified;
                     db.SaveChanges();
                 }
                 if (bookingUpdated == null)
                 {
                     return HttpNotFound();
                 }
                 Booking thisbooking = db.Bookings.Where(b =&#62; b.InvoiceId == invoiceUpdated.InvoiceId).FirstOrDefault();
                 thisbooking.BookingStartDateTime = bookingUpdated.BookingStartDateTime;
                 thisbooking.BookingEndDateTime = bookingUpdated.BookingEndDateTime;
                 thisbooking.ItemDescription = bookingUpdated.ItemDescription;
                 thisbooking.BookingStatus = bookingUpdated.BookingStatus;
                 thisbooking.Subtotal = bookingUpdated.Subtotal;
                 thisbooking.BookingDeposit = bookingUpdated.BookingDeposit;
                 thisbooking.BookingAdjustmentHrs = bookingUpdated.BookingAdjustmentHrs;
                 thisbooking.BookingCancellationFee = bookingUpdated.BookingCancellationFee;
                 thisbooking.UnitPriceId = bookingUpdated.UnitPriceId;
                 if (ModelState.IsValid)
                 {
                     db.Entry(thisbooking).State = EntityState.Modified;
                     db.SaveChanges();
                 }
             }
             TempData[&#34;BookingUpdated&#34;] = bookingUpdated;
         }
 
         return RedirectToAction(&#34;Show&#34;, new { id = transaction.Id });
     }
     else if (result.Transaction != null)
     {
         return RedirectToAction(&#34;Show&#34;, new { id = result.Transaction.Id });
     }
     else
     {
         string errorMessages = &#34;&#34;;
         foreach (ValidationError error in result.Errors.DeepAll())
         {
             errorMessages += &#34;Error: &#34; + (int)error.Code + &#34; - &#34; + error.Message + &#34;\n&#34;;
         }
         TempData[&#34;Flash&#34;] = errorMessages;
 
 
         return RedirectToAction(&#34;New&#34;);
     }
 
 }
</CodeSnippet>

  </div>
</CollapsibleArea>



<CollapsibleArea runat="server" Expanded="1" Title="Platforms" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="platformsTitleToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>
  
  <p> Windows 7 and above</p>
  <p>
  </p>

  <span xmlns="http://www.w3.org/1999/xhtml">
		The .NET Framework does not support all versions of every platform. For a list of the supported versions, see 
		<a href="ms-xhelp:///?Id=298275e2-da1d-4618-9f74-6a3567832350">System Requirements</a>.
  </span>
</CollapsibleArea>



  



	
	
	
	


<CollapsibleArea runat="server" Expanded="1" Title="Version Information" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="versionsTitleToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>
  <h4 class="subHeading">.NET Framework</h4>Supported in: 4.6, 4.5, 4, 3.5, 3.0, 2.0, 1.1, 1.0<br />

  <h4 class="subHeading">.NET Framework Client Profile</h4>Supported in: 4, 3.5 SP1<br />






</CollapsibleArea>

<CollapsibleArea runat="server" Expanded="1" Title="See Also" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="seeAlsoToggle" xmlns="http://www.w3.org/1999/xhtml"><!---->
  </a>
  <h4 class="subHeading" xmlns="http://www.w3.org/1999/xhtml">Reference</h4>
		  <div class="seeAlsoStyle" xmlns="http://www.w3.org/1999/xhtml">
    <a class="mtps-internal-link" href="ms-xhelp:///?id=T:AlfaAccounting.Controllers.BookingViewModelsController">BookingViewModelsController Class</a>
  </div>
  <div class="seeAlsoStyle" xmlns="http://www.w3.org/1999/xhtml">
    <a class="mtps-internal-link" href="ms-xhelp:///?id=AllMembers.T:AlfaAccounting.Controllers.BookingViewModelsController">BookingViewModelsController Members</a>
  </div>



	  <div class="seeAlsoStyle" xmlns="http://www.w3.org/1999/xhtml">
	    <a class="mtps-internal-link" href="ms-xhelp:///?Id=N:AlfaAccounting.Controllers">AlfaAccounting.Controllers Namespace</a>
	  </div>


		

</CollapsibleArea>
        </div>
      </div>
      
			<div class="OH_footer">
				<p><span style="color:#FF0000;">Generated with unregistered version of <a href="ms-xhelp:///?Id=http://www.helixoft.com/vsdocman/overview.html">VSdocman</a></span>&#32;<br />
Your own footer text will only be shown in registered version.
				</p>
			</div>
      
    </div>
  </body>
</html>

