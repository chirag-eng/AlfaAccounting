<?xml version="1.0" encoding="utf-8"?><html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta name="ROBOTS" content="NOINDEX, NOFOLLOW" />
    <title>BookingViewModelsController.AmendBookingConfirmation  Method</title>
    <meta name="Microsoft.Help.TopicVersion" content="10" />
    <meta name="Microsoft.Help.Id" content="M:AlfaAccounting.Controllers.BookingViewModelsController.AmendBookingConfirmation" />
    <meta name="SelfBranded" content="false" />
    <meta name="Title" content="BookingViewModelsController.AmendBookingConfirmation  Method" />
    <meta name="Microsoft.Help.TocParent" content="Overload:AlfaAccounting.Controllers.BookingViewModelsController.AmendBookingConfirmation" />
    
    <meta name="Microsoft.Help.ContentType" content="Reference" />
    <meta name="Microsoft.Help.Category" content="TargetOS:Windows" />
    <meta name="Microsoft.Help.Category" content="DevLang:VB" />
    <meta name="Microsoft.Help.Category" content="DevLang:CSharp" />
    <meta name="Microsoft.Help.Category" content="DevLang:FSharp" />
    <meta name="Description" content="AlfaAccounting.Controllers.BookingViewModelsController.AmendBookingConfirmation Method" />
    <meta name="Microsoft.Help.TOCParentTopicVersion" content="10" />
    <meta name="Microsoft.Help.TocOrder" content="0" />
    <meta name="Microsoft.Help.Product" content="AlfaAccounting Reference" />
    <style type="text/css">.class-diagram img {border: none;}</style>
    <script src="mshv2.js"></script>
  </head>
    <body class="primary-mtps-offline-document" 
	onload="try{onLoad(); var nod=document.getElementById('vsdocman_init_script');var newNod=document.createElement('script');newNod.type= 'text/javascript';nod.parentNode.replaceChild(newNod,nod);newNod.text=nod.innerHTML;vsdocman_topic_init();}catch(ex){}">
  
<div id="vsdocman_init_script" style="display:none;">
// <!-- the script cannot contain the following text (without dots): -.-.> or -.-
function vsdocman_topic_init() {
	try {
		extractCode();
	} catch (ex) {
	}
	
	try {
		var divs = document.documentElement.getElementsByTagName("div");
		var i;
		var footerRemoved = false;
		for (i=divs.length-1; i>=0; i=i-1) {
			var div = divs[i];
	
			// remove VS branding footer
			if (!footerRemoved) {
				if (div.className == "OH_footer") {
					div.style.display = "none";
					footerRemoved = true;
				}
			}
			
			// remove VS branding feedback link
			if (div.className == "OH_feedbacklink") {
				div.style.display = "none";
			}
		}

		var tds = document.documentElement.getElementsByTagName("td");
		for (i=0; i<tds.length; i++) {
			var td = tds[i];
	
			// remove VS branding logo
			if (td.className == "OH_tdLogoColumn") {
				td.style.display = "none";
			}
		}
	} catch (ex) {
	}
	
	hideImageMapAreaLinks();
	fixLinks();
	fixNewlinesInSyntax();
}


/**
 * Fixes <br />\n sequences in syntax declarations. Only <br/> 
 * is needed.
 */  
function fixNewlinesInSyntax() {
	try {
		var i;
		var snippets = document.documentElement.getElementsByTagName("CodeSnippet");
		for (i=0; i<snippets.length; i++) {
			var containsMarkup = snippets[i].getAttribute("ContainsMarkup");
			if (containsMarkup == "true") {
				// it is syntax section
				// surround fixed text with <pre> tag, otherwise IE normalizes all whitespaces during setting innerHTML
				snippets[i].parentNode.innerHTML = "<pre>" + snippets[i].parentNode.innerHTML.replace(/<br>\r?\n/gi, "<br>") + "</pre>";
			}
		}
	} catch (ex) {
	}
}


/**
 * MS Help Viewer (at least version 1) removes style="display:none;". 
 * Set it back.
 */  
function hideImageMapAreaLinks() {
	try {
		var i;
		var maps = document.documentElement.getElementsByTagName("map");
		for (i=0; i<maps.length; i++) {
			var mapId = maps[i].getAttribute("name");
			var invisibleLinks = document.getElementById("invisible_imagemap_links_" + mapId);
			invisibleLinks.style.display="none";
		}
	} catch (ex) {
	}
}


// Escapes id query variables in internal links and corrects external links. 
function fixLinks() {
	try {
		var i;
		var links = document.documentElement.getElementsByTagName("a");
		var urlParameters = getUrlParameters();
		for (i=0; i<links.length; i++) {
			var hrf = links[i].getAttribute("hr" + "ef");
			var escaped = escapeIdQueryVariable(hrf);
			
			var idValue = escaped[1];
			if (idValue != "") {
				var isExternal = (idValue.toLowerCase().indexOf("http://", 0) >= 0);
				isExternal = isExternal || (idValue.toLowerCase().indexOf("https://", 0) >= 0);
				var isHttp = isExternal;
				isExternal = isExternal || (idValue.toLowerCase().indexOf("mailto:", 0) >= 0);
				if (isExternal) {
					// external link
					//  Help3 system converts each Id to uppercase, so convert it to lowercase.
					//  It's bigger chance the URL will be correct.
					hrf = idValue.toLowerCase();
					if (isHttp) {
						links[i].className = "mtps-external-link";
					}
				} else {
					// help3 link
					hrf = escaped[0];
					// some links (e.g. in syntax section) don't have complete parameters generated by Help3 system
					if (hrf.indexOf("method=page", 0) < 0) {
						hrf = hrf + "&" + urlParameters;
					}
				}
	
				links[i].setAttribute("hr" + "ef", hrf);
			}
		}
	} catch (ex) {
	}
}


var idQueryVariablePattern = /(\&|\?|^)(id\=)(.*?)(\&|$)/i;

// Returns array with 2 items. The first one is resulting complete queryString with
// escaped id variable. The second one is original value of id variable. 
function escapeIdQueryVariable(input) {
	var match = input.match(idQueryVariablePattern);
	var idValue = "";
	if (match) {
		idValue = input.match(idQueryVariablePattern)[3];
		input = input.replace(idQueryVariablePattern, "$1$2" + escape(idValue) + "$4");
	}
	var res = new Array();
	res[0] = input;
	res[1] = idValue;
	return res;
} 


function getUrlParameters() {
	var res;
	res = "product=" + getQueryVariable("product") + "&";
	res = res + "productversion=" + getQueryVariable("productversion") + "&";
	res = res + "method=page&";
	return res;
}


function getQueryVariable(variable) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0; i<vars.length; i++) {
    var pair = vars[i].split("=");
    if (pair[0].toLowerCase() == variable.toLowerCase()) {
      return pair[1];
    }
  }
  return "";
} 


function extractCode(parentNode) {
	var comments = getAllComments(parentNode);

	var comment;
  for(var i=0; i<comments.length; i++){
    comment = comments[i];
  	var matches = comment.nodeValue.match(/(?:^\s*VSDOCMAN SCRIPT)((.|\r\n)*)$/);
		// Match returns array. Index 0 is complete match. Index 1 is the first captured group.
		// The group is defined by (). The ?: means that the group is not captured. 
  	if (matches != null) {
	    //res.push(matches[1]);
	    createElement("div", matches[1], comment);
    }
  }
}


function getAllComments(parentNode) {
	if (parentNode == null) {
		parentNode = document.documentElement;
	}
	var children = parentNode.childNodes;
	var res = new Array();
  if(parentNode.nodeType == 8){
  	// 8 = comment
    res.push(parentNode);
  }
	    
  for(var i=0; i<children.length; i++){
      res = res.concat(getAllComments(children[i]));
  }
  return (res);
}


// Create new element and replace existing one with it
function createElement(name, innerHtml, oldElm) {
	// setting innerHTML containing script tags doesn't work in IE
	var scriptBodies = new Array();
	var scriptMatch;
	var i = 0;
	var scriptPattern = /(<script.*?>)((.|\r\n)*?)(<\/script>)/i;
	do {
		scriptMatch = innerHtml.match(scriptPattern);
		if (scriptMatch != null) {
			// found the script tag
			//  get its innerHtml
			scriptBodies[i] = scriptMatch[2];
			// replace this script tag with span tag
			innerHtml = innerHtml.replace(scriptPattern, "<span script_index=\"" + i + "\"></span>");
		}
		i++;
	} while(scriptMatch != null && i < 100);
	
	var elm = document.createElement(name);
	elm.innerHTML = innerHtml;
	oldElm.parentNode.replaceChild(elm,oldElm);
	
	// now create script tags and replace corresponding span tags
	var allSpans = elm.getElementsByTagName('span');
	var scriptSpans = new Array();
	for (i=0; i<allSpans.length; i++) {
		if (allSpans[i].getAttribute("script_index")) {
			var index = allSpans[i].getAttribute("script_index");
			scriptSpans[index] = allSpans[i];
		}
	}
	for (i=0; i<scriptBodies.length; i++) {
		insertScriptElement(scriptBodies[i], scriptSpans[i], getUniqueIndex());
	}
}

var uniqueIndex = 0;
function getUniqueIndex() {
	return uniqueIndex++;
}

function insertScriptElement(innerHtml, oldNode, scriptIndex) {
	var newNod=document.createElement('script');
	newNod.type = 'text/javascript';
	newNod.setAttribute("defer", "defer");
	oldNode.parentNode.replaceChild(newNod, oldNode);
	// add a test whether the script was evaluated
	var newInnerHtml = "\nvar vsdocmanScript" + scriptIndex + "executed = true;\n" + innerHtml;
	newNod.text=newInnerHtml;
	//run the script if necessary
	try {
		eval("vsdocmanScript" + scriptIndex + "executed");
	} catch (ex) {
		// not evaluated yet
		eval(innerHtml);
	}
}

// *** CLASS DIAGRAM CLICKING ***
// To navigate any kind of link, we need to call click() method on the element.
// It's because of <MSHelp:link links in Help2 format (only used in IE). 
// Default click event in FF doesn't trigger the link (in IE it does).
// Fix it. 
function performClick(element) {
	if (document.createEventObject){
		// IE
		return element.click();
	}
	else{
		// dispatch for firefox + others
		var evt = element.ownerDocument.createEvent('MouseEvents');
		evt.initMouseEvent('click', true, true, element.ownerDocument.defaultView, 1, 0, 0, 0, 0, false, false, false, false, 0, null);
		element.dispatchEvent(evt);
	}
	
	while (element) {
		if (element.tagName == "A" && element.href != "") {
			if (element.target != "") {
				window.open(element.href, element.target);
			} else {
				document.location = element.href;
			}
			element = null;
		}	else {
			element = element.parentElement;
		}
	}
}

function clickElement(callerElement) {
	try {
		var elementHTML;
		var tagName;
		var innerCode;
		var attributes;
		var clickActionGuid;
		
		// get HTML source code of element to be clicked 
		clickActionGuid = callerElement.getAttribute("click-cref-guid");
		elementHTML = document.getElementById(clickActionGuid).innerHTML;
		
		// parse HTML element code
		var elementPattern = /<(.+?)\s+(.*)>(.*)<.+?>/igm;
		elementPattern.lastIndex = 0;
		var match = elementPattern.exec(elementHTML);
		tagName = match[1];
		attributes = match[2];
		innerCode = match[3];
		
		//get array of "attr=value" strings 	
		attributes = unescapeHTML(attributes);
		attributes = attributes.match(/\s*(.*?)\s*=\s*(["'])(.*?)\2/igm);
		
		// create element with attributes
		var el = document.createElement(tagName);
		//el.innerHTML = innerCode;
		var i;
		var attrPattern = /\s*(.*?)\s*=\s*(["'])(.*?)\2/igm;
		for (i=0; i<attributes.length; i++) {
			attrPattern.lastIndex = 0;
			match = attrPattern.exec(attributes[i]);
			el.setAttribute(match[1], match[3]);
		}

		document.body.appendChild(el);
		performClick(el);
	} catch (ex) {
	}
	return false;
}

function unescapeHTML (str) {
	return str.replace(/&amp;/g,"&").
		replace(/>/g,"&gt;").
		replace(/</g,"&lt;");//. 
		//the following doesn't work for some reason: replace(/"/g,"&quot;");                                         
}

// -->		
</div>
    <div class="topic">
      <div class="majorTitle">AlfaAccounting Reference
      </div>
      <div class="title">BookingViewModelsController.AmendBookingConfirmation  Method
      </div>
      <div id="mainSection">
        <div id="mainBody">
          <div>
            <div class="summary">
       
			        Create VisitRefundViewModel model using data passed from tempdata BookingOriginal, BookingUpudated, Invoice Original, Invoice Updated
that get passed to amend booking confirmation view


            </div>
          </div>
          <p>
          </p>

          <strong>Namespace:</strong> 
<a href="ms-xhelp:///?Id=N:AlfaAccounting.Controllers">AlfaAccounting.Controllers</a>



<br />

    
          <strong>Assembly:</strong>
          <span>AlfaAccounting (in AlfaAccounting.dll)</span>








<CollapsibleArea runat="server" Expanded="1" Title="Syntax" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="syntaxToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>

            
            
						
	<CodeSnippet xml:space="preserve" runat="server" Language="CSharp" DisplayLanguage="C#" ContainsMarkup="true" EnableCopyCode="false">public ActionResult AmendBookingConfirmation()</CodeSnippet>
            
						
            
						






<div id="returns" xmlns="http://www.w3.org/1999/xhtml">
  <h4 class="subHeading">Return Value</h4>
  <span>
	Type: <a href="ms-xhelp:///?Id=T:System.Web.Mvc.ActionResult">ActionResult</a><br />
	    <span>AmendBookingConfirmation with the model data</span>
    <br />
	
  </span>
</div>










</CollapsibleArea>





















<CollapsibleArea runat="server" Expanded="1" Title="Source code" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="sourceCodeToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>
  <div id="snippetGroup" xmlns="http://www.w3.org/1999/xhtml">

<CodeSnippet EnableCopyCode="true" runat="server" Language="CSharp" ContainsMarkup="false" DisplayLanguage="C#" xmlns="http://msdn2.microsoft.com/mtps">
public ActionResult AmendBookingConfirmation()
 {
     //extract temp data passed from the AmendBookDates controller
     var bookingOriginal = TempData[&#34;BookingOriginal&#34;] as Booking;
     var bookingUpdated = TempData[&#34;BookingUpdated&#34;] as Booking;
     var invoiceOriginal = TempData[&#34;InvoiceOriginal&#34;] as Invoice;
     var invoiceUpdated = TempData[&#34;InvoiceUpdated&#34;] as Invoice;
     //in case back button is clicked
     if (bookingOriginal != null)
     {
         //put above before update and after updated booking data into list to dispaly in the view
         var listBothBookings = new List&#60;Booking&#62;();
         listBothBookings.Add(bookingOriginal);
         listBothBookings.Add(bookingUpdated);
         //put above before update and after updated invoice data into list to dispaly in the view
         var listBothInvoices = new List&#60;Invoice&#62;();
         listBothInvoices.Add(invoiceOriginal);
         listBothInvoices.Add(invoiceUpdated);
         //get user and pay history to display in the view
         ApplicationUser user = db.Users.Where(u =&#62; u.Id == bookingOriginal.Id).FirstOrDefault();
         //get payment history to display in the view
         List&#60;PaymentHistory&#62; listpayhis = db.PaymentHistories.Where(ph =&#62; ph.InvoiceId == bookingOriginal.InvoiceId).ToList();
         //clculate the refund or additional payment amount 
         //first get unit price
         var orginalBkgUnitPrice = (float)db.UnitPrices.Where(i =&#62; i.UnitPriceId == bookingOriginal.UnitPriceId).FirstOrDefault().UnitPriceValue;
         //get original booking duration and amended booking duration to compare if the duration changed.
         var originalBookingDuration = (float)((bookingOriginal.BookingEndDateTime - bookingOriginal.BookingStartDateTime).TotalHours);
         var amendedBookingDuration = (float)((bookingUpdated.BookingEndDateTime - bookingUpdated.BookingStartDateTime).TotalHours);
         ////get depostirate
         //var depositrate = (float)db.DepositRates.SingleOrDefault().DepositRateValue;
         //var originalDeposit = originalBookingDuration * orginalBkgUnitPrice*depositrate;
         //var amendedDeposit = amendedBookingDuration * orginalBkgUnitPrice*depositrate;
         var refundamount = 0f;
         var additionalpayamount = 0f;
         //if original duration is less thatn amended booking duration additional payment of the difference must be charged
         if (originalBookingDuration &#60;= amendedBookingDuration)
         {
             additionalpayamount = bookingUpdated.BookingDeposit - bookingOriginal.BookingDeposit + bookingUpdated.BookingCancellationFee;
         }
         //if original duration is more than amended booking duration the difference must be refunded.
         else if (originalBookingDuration &#62; amendedBookingDuration)
         {
             refundamount = (bookingOriginal.BookingDeposit - bookingUpdated.BookingDeposit);
         }
 
         //create view model reusing the visit refund viewmodel;
         VisitRefundViewModel model = new VisitRefundViewModel();
 
         model.ApplicationUser = user;
         model.Bookings = listBothBookings;
         model.Invoices = listBothInvoices;
         model.RefundAmount = refundamount;
         model.AdditionalPaymentAmount = additionalpayamount;
         model.PaymentHistories = listpayhis;
         TempData[&#34;AmendBookingModel&#34;] = model;
         TempData[&#34;BookingUpdated&#34;] = bookingUpdated;
         TempData[&#34;InvoiceUpdated&#34;] = invoiceUpdated;
         //return the view the model data above
         return View(model);
     }
     // in case back button is clicked return view without model
     return View(&#34;MyBooking&#34;);
 }
</CodeSnippet>

  </div>
</CollapsibleArea>



<CollapsibleArea runat="server" Expanded="1" Title="Platforms" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="platformsTitleToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>
  
  <p> Windows 7 and above</p>
  <p>
  </p>

  <span xmlns="http://www.w3.org/1999/xhtml">
		The .NET Framework does not support all versions of every platform. For a list of the supported versions, see 
		<a href="ms-xhelp:///?Id=298275e2-da1d-4618-9f74-6a3567832350">System Requirements</a>.
  </span>
</CollapsibleArea>



  



	
	
	
	


<CollapsibleArea runat="server" Expanded="1" Title="Version Information" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="versionsTitleToggle" xmlns="http://www.w3.org/1999/xhtml">
  </a>
  <h4 class="subHeading">.NET Framework</h4>Supported in: 4.6, 4.5, 4, 3.5, 3.0, 2.0, 1.1, 1.0<br />

  <h4 class="subHeading">.NET Framework Client Profile</h4>Supported in: 4, 3.5 SP1<br />






</CollapsibleArea>

<CollapsibleArea runat="server" Expanded="1" Title="See Also" xmlns="http://msdn2.microsoft.com/mtps">
  <a id="seeAlsoToggle" xmlns="http://www.w3.org/1999/xhtml"><!---->
  </a>
  <h4 class="subHeading" xmlns="http://www.w3.org/1999/xhtml">Reference</h4>
		  <div class="seeAlsoStyle" xmlns="http://www.w3.org/1999/xhtml">
    <a class="mtps-internal-link" href="ms-xhelp:///?id=T:AlfaAccounting.Controllers.BookingViewModelsController">BookingViewModelsController Class</a>
  </div>
  <div class="seeAlsoStyle" xmlns="http://www.w3.org/1999/xhtml">
    <a class="mtps-internal-link" href="ms-xhelp:///?id=AllMembers.T:AlfaAccounting.Controllers.BookingViewModelsController">BookingViewModelsController Members</a>
  </div>



	  <div class="seeAlsoStyle" xmlns="http://www.w3.org/1999/xhtml">
	    <a class="mtps-internal-link" href="ms-xhelp:///?Id=N:AlfaAccounting.Controllers">AlfaAccounting.Controllers Namespace</a>
	  </div>


		

</CollapsibleArea>
        </div>
      </div>
      
			<div class="OH_footer">
				<p><span style="color:#FF0000;">Generated with unregistered version of <a href="ms-xhelp:///?Id=http://www.helixoft.com/vsdocman/overview.html">VSdocman</a></span>&#32;<br />
Your own footer text will only be shown in registered version.
				</p>
			</div>
      
    </div>
  </body>
</html>

   